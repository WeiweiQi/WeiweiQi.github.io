---
title: 若依中的代码自动生成器研究-表查询篇
comments: true
date: 2021-11-08 08:13:25
categories:
tags:
---

这是我参与11月更文挑战的第7天，活动详情查看：[2021最后一次更文挑战](https://juejin.cn/post/7023643374569816095/)

最近生产环境用了一个开源系统：[若依](http://ruoyi.vip/)，其中有一个版块很有意思，很能提高生产效率，也就是代码生成器。

其功能所处模块菜单为：系统工具->代码生成。我们来研究一下他的代码生成逻辑。



## 工具使用方法

1. 建表

   使用代码生成，首先需要在数据库建立一个业务表，比如我们要建立系统的用户表：表名称为`my_user`, 如下图

   ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bceaa26aea1943d8b20c2bad4c18751d~tplv-k3u1fbpfcp-watermark.image?)

2. 导入

   在若依“系统工具”->“代码生成”中，点击“导入”

   ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab00740838e24e898ef794d7771751f0~tplv-k3u1fbpfcp-watermark.image?)

   在弹出窗口中，勾选`my_user`，然后点击“确定”，之后在列表界面可以看到导入的表：

   ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9e0c3619e824e248612bb6a1bc799bf~tplv-k3u1fbpfcp-watermark.image?)

3. 代码预览

   点击`my_user`后面的“预览”，即可查看预生成的代码，预览代码生成很快，几乎没有延迟。

   ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb7e790f9e1f4e4d954dd863520ebb72~tplv-k3u1fbpfcp-watermark.image?)

   而且预览代码分为很多个部分，包括domain.java, mapper.java, service.java, serviceImpl.java, controller.java， mapper.xml以及前端的`.vue`文件与接口请求`.js`文件。

## 代码生成逻辑研究

### sql查找

我们根据各个步骤请求的接口来研究一下代码生成逻辑。

点击“导入”时，窗口弹出数据库中的表列表，我们通过F12浏览器调试，发现其调用接口为`/tool/gen/db/list`，在后台我们去查看这个接口。接口入口如下图，在`ruoyi-generator`版块中。

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e5cf73ce91274c9eadc50fa0e6fc2a41~tplv-k3u1fbpfcp-watermark.image?)

其SQL查询语句经过逐级查找，位于`GenTableMapper.xml`中：

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfe1acadd3a149c8ac80dbb5c0706e93~tplv-k3u1fbpfcp-watermark.image?)

咱们拷贝出来：

```sql
SELECT
	table_name,
	table_comment,
	create_time,
	update_time
FROM
	information_schema. TABLES
WHERE
	table_schema = (SELECT DATABASE())
AND table_name NOT LIKE 'qrtz_%'
AND table_name NOT LIKE 'gen_%'
AND table_name NOT IN (
	SELECT
		table_name
	FROM
		gen_table
)
ORDER BY
	create_time DESC
```

其中的`SELECT DATABASE()`可以查询当前所在数据库的数据库名称。`information_schema. TABLES`会显示目前本台mysql连接上的所有数据库。字段`table_comment`会显示我们在创建表时写的注释，即在navcat上的这一部分：

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a472299b896842fba79777fa19f62c0d~tplv-k3u1fbpfcp-watermark.image?)

